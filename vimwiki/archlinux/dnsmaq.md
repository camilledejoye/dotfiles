# Installation

```sh
pacman -S dnsmasq
```

Then enable and start the service:
```sh
systemctl enable --now dnsmasq
```

# Configuration

### Using [openresolv](https://wiki.archlinux.org/title/Openresolv)

openresolv will handle the configuration of the `/etc/resolv.conf` file automatically so that
dnsmasq can be used without having to manually define the fallback DNS addresses.

#### Disable NetworkManager handling of `/etc/resolv.conf`

By default NetworkManager will overwrite the `/etc/resolv.conf` file but we want openresolv to do it.
Create a file `/etc/NetworkManager/conf.d/rc-manager.conf` with the following content:
```ini
[main]
# https://wiki.archlinux.org/title/NetworkManager#Use_openresolv
rc-manager=resolvconf
```

And restart NetworkManager:
```sh
systemctl restart NetworkManager
```

#### Configure openresolv

Create the file `/etc/dnsmasq.conf` with the following content:
```sh
# Use the loopback address to resolve names with dnsmasq
# This is suggested on line but the ::1 makes it super slow
# name_servers="::1 127.0.0.1"
name_servers="127.0.0.1"
resolv_conf_options="trust-ad"

# Define where openresolv will write dnsmasq and resolv configurations
dnsmasq_conf=/etc/dnsmasq-conf.conf
dnsmasq_resolv=/etc/dnsmasq-resolv.conf
```

#### Configure dnsmasq

Create the file `/etc/dnsmasq.conf` with the following content:
```sh
# Resolve *.loc addresses with IP 127.0.0.1
address=/.loc/127.0.0.1

# Listen on the loopback address
listen-address=127.0.0.1

# Read configuration generated by openresolv
conf-file=/etc/dnsmasq-conf.conf
resolv-file=/etc/dnsmasq-resolv.conf
```

#### Generate `/etc/resolv.conf`

Now that openresolv handle this file automatically we must generate it:
```sh
openresolv -u
```

Sometime I have an error like:
```sh
/usr/lib/resolvconf/libc.d/avahi-daemon: line 31: kill: (293448) - No such process
```

In which case running the command again seems to work (or try to restart NetworkManager/dnsmasq maybe).

#### Restart NetworkManager & dnsmasq

It might not be necessary but just to be sure:
```sh
systemctl restart NetworkManager
systemctl enable dnsmasq
```

### Manual

Create the file `/etc/dnsmasq.conf` with the following content:
```sh
# Resolve *.loc addresses with IP 127.0.0.1
address=/.loc/127.0.0.1

# Listen on the loopback address
listen-address=127.0.0.1

# Configure the fallback DNS to use Google servers
server=8.8.8.8
server=8.8.4.4
```

#### Disable NetworkManager handling of `/etc/resolv.conf`

By default NetworkManager will overwrite the `/etc/resolv.conf` file, this must be disabled to prevent it for
overriding the configuration of `dnsmasq`.

Create a file `/etc/NetworkManager/conf.d/dns.conf` with the following content:
```ini
[main]
# https://wiki.archlinux.org/title/NetworkManager#Unmanaged
dns=none
```

And restart NetworkManager:
```sh
systemctl restart NetworkManager
```

#### Configure dnsmasq

Replace the content of `/etc/resolv.conf` by:
```sh
# Use the loopback address to resolve names with dnsmasq
nameserver 127.0.0.1
```

#### Restart NetworkManager & dnsmasq

It might not be necessary but just to be sure:
```sh
systemctl restart NetworkManager
systemctl enable dnsmasq
```
